<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandyHandle - Gestión de Vuelos</title>
  <link rel="stylesheet" href="/templates/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
    }
    .header {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      margin: 0;
      font-size: 24px;
    }
    .logout-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .logout-btn:hover {
      background-color: #c82333;
    }
    .container {
      padding: 20px;
    }
    #map-container {
      position: relative;
      margin-bottom: 20px;
    }
    #map {
      height: 400px;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: height 0.3s ease;
    }
    #map.minimized {
      height: 100px;
    }
    #map-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    #map-toggle:hover {
      background-color: #0056b3;
    }
    #flights-table-container {
      margin-top: 20px;
    }
    #flights-table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    #flights-table th,
    #flights-table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    #flights-table th {
      background-color: #007bff;
      color: white;
    }
    #flights-table tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    #flights-table tbody tr:hover {
      background-color: #e9ecef;
    }
    #pagination {
      margin-top: 10px;
      text-align: center;
    }
    #pagination button {
      padding: 5px 10px;
      margin: 0 5px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #pagination button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #pagination span {
      margin: 0 10px;
    }
    #chat-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 300px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      transition: height 0.3s ease;
    }
    #chat-container.minimized {
      height: 40px;
    }
    #chat-container h3 {
      margin: 0;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    #chat-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    #unread-count {
      position: absolute;
      top: 5px;
      right: 30px;
      background-color: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      display: none;
    }
    #chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      border-bottom: 1px solid #ccc;
      display: none;
    }
    #chat-container:not(.minimized) #chat-messages {
      display: block;
    }
    .chat-message {
      margin-bottom: 10px;
      word-wrap: break-word;
    }
    .chat-message audio {
      width: 100%;
    }
    #chat-input {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      display: none;
    }
    #chat-container:not(.minimized) #chat-input {
      display: flex;
    }
    #chat-input input {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }
    #chat-input button {
      padding: 5px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #chat-input button:hover {
      background-color: #0056b3;
    }
    #recording-status {
      color: red;
      font-size: 0.9em;
    }
    #filters {
      margin-bottom: 20px;
    }
    #filters input {
      padding: 5px;
      margin-right: 10px;
      width: 200px;
    }
    #filters button {
      padding: 5px 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #filters button:hover {
      background-color: #0056b3;
    }
    .update-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    #update-btn {
      padding: 5px 10px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #update-btn:hover {
      background-color: #218838;
    }
    .details-row {
      display: none;
    }
    .details-row.visible {
      display: table-row;
    }
    #users-connected {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Bienvenido, {{ user.apellido }} ({{ user.position }})</h1>
    <button class="logout-btn" onclick="window.location.href='/logout'">Cerrar Sesión</button>
  </div>

  <div class="container">
    <img src="/templates/logo.png" alt="Logo" style="max-width: 200px; margin-bottom: 20px;">

    <div id="map-container">
      <button id="map-toggle">Minimizar Mapa</button>
      <div id="map"></div>
    </div>

    <div id="filters">
      <label>Vuelos disponibles</label>
      <br>
      <input type="text" id="search-input" placeholder="Ej. AR AEP EZE">
      <button onclick="filterFlights()">Filtrar</button>
    </div>

    <div class="update-info">
      <span>Última actualización: <span id="last-update">Cargando...</span></span>
      <button id="update-btn" onclick="updateFlightsTable()">Actualizar vuelos</button>
      <span>Habilitar voz para llegadas: <input type="checkbox" id="voice-notifications"></span>
      <span>Usuarios conectados: <span id="users-count">0</span></span>
      <div id="users-connected"></div>
    </div>

    <div id="flights-table-container">
      <table id="flights-table">
        <thead>
          <tr>
            <th>Vuelo</th>
            <th>Aerolínea</th>
            <th>Salida</th>
            <th>Arribo</th>
            <th>Hora Salida</th>
            <th>Hora Arribo</th>
            <th>Estado</th>
            <th>➕</th>
          </tr>
        </thead>
        <tbody id="flights-tbody"></tbody>
      </table>
      <div id="pagination">
        <button id="prev-page" disabled>Anterior</button>
        <span id="page-info">Página 1 de 1</span>
        <button id="next-page" disabled>Siguiente</button>
      </div>
    </div>

    <div id="chat-container">
      <h3>
        Chat Global
        <span id="unread-count">0</span>
        <button id="chat-toggle">−</button>
      </h3>
      <div id="chat-messages"></div>
      <div id="chat-input">
        <input type="text" id="chat-message-input" placeholder="Escribe un mensaje...">
        <button id="send-message">Enviar</button>
        <button id="record-audio">Grabar Audio</button>
        <span id="recording-status"></span>
      </div>
    </div>
  </div>

  <script>
    // Inicializar el mapa
    const map = L.map("map").setView([-34.5592, -58.4156], 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let markers = [];

    // Función para actualizar el mapa
    function updateMap(flights) {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      flights.forEach(flight => {
        if (flight.lat && flight.lon) {
          const marker = L.marker([flight.lat, flight.lon]).addTo(map);
          marker.bindPopup(`
            <b>Vuelo:</b> ${flight.flight_iata}<br>
            <b>Aerolínea:</b> ${flight.airline_name}<br>
            <b>Salida:</b> ${flight.departure_airport} (${flight.departure})<br>
            <b>Arribo:</b> ${flight.arrival_airport} (${flight.arrival})<br>
            <b>Hora Est. Salida:</b> ${flight.estimated_departure}<br>
            <b>Hora Est. Arribo:</b> ${flight.estimated_arrival}<br>
            <b>Estado:</b> ${flight.status}
          `);
          markers.push(marker);
        }
      });
    }

    let currentPage = 1;
    let totalPages = 1;
    let allFlights = [];
    let filteredFlights = [];

    // Función para filtrar vuelos
    function filterFlights() {
      const searchInput = document.getElementById("search-input").value.toUpperCase().trim();
      const terms = searchInput.split(" ");

      filteredFlights = allFlights.filter(flight => {
        const airlineMatch = terms.includes("AR") ? flight.airline_iata === "AR" : true;
        const departureMatch = terms.some(term => flight.departure === term || flight.departure_airport.includes(term));
        const arrivalMatch = terms.some(term => flight.arrival === term || flight.arrival_airport.includes(term));
        return airlineMatch && (departureMatch || arrivalMatch);
      });

      totalPages = Math.ceil(filteredFlights.length / 25);
      currentPage = 1;
      renderFlights();
    }

    // Función para renderizar los vuelos
    function renderFlights() {
      const flightsPerPage = 25;
      const startIdx = (currentPage - 1) * flightsPerPage;
      const endIdx = startIdx + flightsPerPage;
      const paginatedFlights = filteredFlights.slice(startIdx, endIdx);

      const tbody = document.getElementById("flights-tbody");
      tbody.innerHTML = "";

      if (paginatedFlights.length > 0) {
        paginatedFlights.forEach((flight, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${flight.flight_iata}</td>
            <td>${flight.airline_name}</td>
            <td>${flight.departure_airport} (${flight.departure})</td>
            <td>${flight.arrival_airport} (${flight.arrival})</td>
            <td>${flight.estimated_departure}</td>
            <td>${flight.estimated_arrival}</td>
            <td>${flight.departure_delay}</td>
            <td>${flight.arrival_delay}</td>
            <td>${flight.departure_gate}</td>
            <td>${flight.arrival_gate}</td>
            <td>${flight.departure_terminal}</td>
            <td>${flight.arrival_terminal}</td>
            <td>${flight.aircraft}</td>
            <td>${flight.status}</td>
            <td>${flight.observations}</td>
            <td><button onclick="toggleDetails(${startIdx + index})">Ver más</button></td>
          `;
          tbody.appendChild(row);

          const detailsRow = document.createElement("tr");
          detailsRow.classList.add("details-row");
          detailsRow.id = `details-${startIdx + index}`;
          detailsRow.innerHTML = `
            <td colspan="16">
              Nombre completo del aeropuerto de salida: ${flight.departure_airport}<br>
              Nombre completo del aeropuerto de llegada: ${flight.arrival_airport}<br>
              Hora programada de salida: ${flight.scheduled_departure}<br>
              Retraso de salida: ${flight.departure_delay} minutos<br>
              Terminal de salida: ${flight.departure_terminal}<br>
              Puerta de salida: ${flight.departure_gate}<br>
              Hora programada de llegada: ${flight.scheduled_arrival}<br>
              Retraso de llegada: ${flight.arrival_delay} minutos<br>
              Terminal de llegada: ${flight.arrival_terminal}<br>
              Puerta de llegada: ${flight.arrival_gate}<br>
              Tipo de avión: ${flight.aircraft}<br>
              Observaciones: ${flight.observations}
            </td>
          `;
          tbody.appendChild(detailsRow);
        });

        updateMap(paginatedFlights);
        document.getElementById("page-info").textContent = `Página ${currentPage} de ${totalPages}`;
        document.getElementById("prev-page").disabled = currentPage === 1;
        document.getElementById("next-page").disabled = currentPage === totalPages;
      } else {
        tbody.innerHTML = `<tr><td colspan="16">No se encontraron vuelos.</td></tr>`;
        updateMap([]);
        document.getElementById("page-info").textContent = `Página 1 de 1`;
        document.getElementById("prev-page").disabled = true;
        document.getElementById("next-page").disabled = true;
      }
    }

    // Función para toggle de detalles
    function toggleDetails(index) {
      const detailsRow = document.getElementById(`details-${index}`);
      detailsRow.classList.toggle("visible");
    }

    // Función para actualizar la tabla de vuelos
    async function updateFlightsTable() {
      try {
        const response = await fetch(`/flights?page=${currentPage}`);
        const data = await response.json();

        allFlights = data.flights || [];
        filteredFlights = [...allFlights];
        totalPages = data.total_pages || 1;
        renderFlights();

        if (data.failed_sources && data.failed_sources.length > 0) {
          alert(`No se pudieron obtener datos de las siguientes fuentes: ${data.failed_sources.join(", ")}`);
        }

        const now = new Date();
        document.getElementById("last-update").textContent = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

        // Notificaciones de voz para llegadas
        const voiceEnabled = document.getElementById("voice-notifications").checked;
        if (voiceEnabled) {
          data.flights.forEach(flight => {
            if (flight.status === "landed" && flight.arrival === "AEP") {
              const msg = new SpeechSynthesisUtterance(`El vuelo ${flight.flight_iata} de ${flight.airline_name} con origen ${flight.departure_airport} ha llegado a Aeroparque.`);
              msg.lang = "es-ES";
              window.speechSynthesis.speak(msg);
            }
          });
        }
      } catch (error) {
        console.error("Error al obtener los vuelos:", error);
        const tbody = document.getElementById("flights-tbody");
        tbody.innerHTML = `<tr><td colspan="16">Error al cargar los vuelos.</td></tr>`;
        updateMap([]);
      }
    }

    // Event listeners para los botones de paginación
    document.getElementById("prev-page").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderFlights();
      }
    });

    document.getElementById("next-page").addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderFlights();
      }
    });

    // Actualizar la tabla al cargar la página
    updateFlightsTable();

    // WebSocket para usuarios conectados
    const ws = new WebSocket(`wss://${window.location.host}/ws`);
    ws.onmessage = (event) => {
      const count = event.data;
      document.getElementById("users-count").textContent = count;

      // Obtener lista de usuarios conectados
      fetch("/users").then(res => res.json()).then(data => {
        const usersDiv = document.getElementById("users-connected");
        usersDiv.innerHTML = "";
        data.users.forEach(user => {
          const userItem = document.createElement("div");
          userItem.textContent = `${user.apellido} (${user.legajo}) - ${user.position}`;
          usersDiv.appendChild(userItem);
        });
      });
    };

    // WebSocket para el chat global
    const chatSocket = new WebSocket(`wss://${window.location.host}/chat`);
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let unreadMessages = 0;
    let isChatMinimized = false;

    chatSocket.onopen = () => {
      console.log("Conexión de chat establecida");
    };

    chatSocket.onmessage = (event) => {
      const message = JSON.parse(event.data);
      const chatMessages = document.getElementById("chat-messages");

      const messageElement = document.createElement("div");
      messageElement.classList.add("chat-message");

      if (message.type === "text") {
        messageElement.innerHTML = `<strong>${message.sender}</strong> (${message.timestamp}): ${message.content}`;
      } else if (message.type === "audio") {
        messageElement.innerHTML = `<strong>${message.sender}</strong> (${message.timestamp}): <audio controls src="${message.content}"></audio>`;
      }

      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      if (isChatMinimized) {
        unreadMessages++;
        const unreadCount = document.getElementById("unread-count");
        unreadCount.textContent = unreadMessages;
        unreadCount.style.display = "block";
      }
    };

    chatSocket.onclose = () => {
      console.log("Conexión de chat cerrada");
    };

    // Enviar mensaje de texto
    document.getElementById("send-message").addEventListener("click", () => {
      const input = document.getElementById("chat-message-input");
      const message = input.value.trim();
      if (message) {
        chatSocket.send(JSON.stringify({
          type: "text",
          sender: "{{ user.apellido }} ({{ user.position }})",
          content: message
        }));
        input.value = "";
      }
    });

    // Manejar grabación de audio
    document.getElementById("record-audio").addEventListener("click", async () => {
      const recordButton = document.getElementById("record-audio");
      const status = document.getElementById("recording-status");

      if (!isRecording) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = () => {
              const base64Audio = reader.result;
              chatSocket.send(JSON.stringify({
                type: "audio",
                sender: "{{ user.apellido }} ({{ user.position }})",
                content: base64Audio
              }));
            };
          };

          mediaRecorder.start();
          isRecording = true;
          recordButton.textContent = "Parar Grabación";
          status.textContent = "Grabando...";
        } catch (error) {
          console.error("Error al acceder al micrófono:", error);
          status.textContent = "Error al grabar audio.";
        }
      } else {
        mediaRecorder.stop();
        isRecording = false;
        recordButton.textContent = "Grabar Audio";
        status.textContent = "";
      }
    });

    // Permitir enviar mensaje con Enter
    document.getElementById("chat-message-input").addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        document.getElementById("send-message").click();
        }
    });

    // Minimizar/expandir chat
    document.getElementById("chat-toggle").addEventListener("click", () => {
      const chatContainer = document.getElementById("chat-container");
      const toggleButton = document.getElementById("chat-toggle");
      isChatMinimized = !isChatMinimized;
      chatContainer.classList.toggle("minimized", isChatMinimized);
      toggleButton.textContent = isChatMinimized ? "+" : "−";
      if (!isChatMinimized) {
        unreadMessages = 0;
        document.getElementById("unread-count").style.display = "none";
      }
    });

    // Minimizar/expandir mapa
    document.getElementById("map-toggle").addEventListener("click", () => {
      const mapDiv = document.getElementById("map");
      const toggleButton = document.getElementById("map-toggle");
      const isMinimized = mapDiv.classList.toggle("minimized");
      toggleButton.textContent = isMinimized ? "Expandir Mapa" : "Minimizar Mapa";
      map.invalidateSize();
    });
  </script>
</body>
</html>
 
