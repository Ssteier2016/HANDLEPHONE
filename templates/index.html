<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandyHandle - Gestión de Vuelos</title>
  <link rel="stylesheet" href="/templates/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
      background-image: url('/templates/fondoaero.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .header {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 1200px;
      box-sizing: border-box;
      position: relative;
    }
    .header h1 {
      margin: 0;
      font-size: 24px;
    }
    .logout-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .logout-btn:hover {
      background-color: #c82333;
    }
    .menu-container {
      position: absolute;
      top: 10px;
      right: 80px;
    }
    .menu-icon {
      cursor: pointer;
      width: 30px;
      height: 30px;
    }
    .menu {
      display: none;
      position: absolute;
      top: 40px;
      right: 0;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    .menu.active {
      display: block;
    }
    .menu-item {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      position: relative;
    }
    .menu-item:last-child {
      border-bottom: none;
    }
    .menu-item:hover {
      background-color: #f0f0f0;
    }
    .submenu {
      display: none;
      position: absolute;
      left: -100%;
      top: 0;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1001;
    }
    .menu-item:hover .submenu {
      display: block;
    }
    .submenu-item {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .submenu-item:last-child {
      border-bottom: none;
    }
    .submenu-item:hover {
      background-color: #f0f0f0;
    }
    .container {
      padding: 20px;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      margin: 20px;
      width: 100%;
      max-width: 1200px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #map-container {
      position: relative;
      margin-bottom: 20px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      transition: height 0.3s ease;
      width: 100%;
      max-width: 800px;
    }
    #map-container.minimized {
      height: 40px;
    }
    #map {
      height: 400px;
      border-radius: 4px;
      display: block;
    }
    #map-container.minimized #map {
      display: none;
    }
    #map-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      z-index: 1000;
    }
    #flights-table-container {
      margin-top: 20px;
      width: 100%;
      max-width: 800px;
    }
    #flights-table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    #flights-table th,
    #flights-table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    #flights-table th {
      background-color: #007bff;
      color: white;
    }
    #flights-table tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    #flights-table tbody tr:hover {
      background-color: #e9ecef;
    }
    #pagination {
      margin-top: 10px;
      text-align: center;
    }
    #pagination button {
      padding: 5px 10px;
      margin: 0 5px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #pagination button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #pagination span {
      margin: 0 10px;
    }
    #chat-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      transition: height 0.3s ease;
    }
    #chat-container.minimized {
      height: 40px;
    }
    #chat-container h3 {
      margin: 0;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    #chat-title-img {
      width: 100px;
      height: auto;
    }
    #chat-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    #unread-count {
      position: absolute;
      top: 5px;
      right: 30px;
      background-color: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      display: none;
    }
    #chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      border-bottom: 1px solid #ccc;
      display: none;
    }
    #chat-container:not(.minimized) #chat-messages {
      display: block;
    }
    .chat-message {
      margin-bottom: 10px;
      word-wrap: break-word;
    }
    .chat-message audio {
      width: 100%;
    }
    #chat-input {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      display: none;
    }
    #chat-container:not(.minimized) #chat-input {
      display: flex;
    }
    #chat-input input {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }
    #chat-input button {
      padding: 5px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #chat-input button:hover {
      background-color: #0056b3;
    }
    #recording-status {
      color: red;
      font-size: 0.9em;
    }
    #filters {
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    #filters label {
      margin-right: 10px;
    }
    #filters input {
      padding: 5px;
      width: 200px;
    }
    #filters button {
      padding: 5px 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #filters button:hover {
      background-color: #0056b3;
    }
    .update-info {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    #update-btn {
      padding: 5px 10px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #update-btn:hover {
      background-color: #218838;
    }
    .details-row {
      display: none;
    }
    .details-row.visible {
      display: table-row;
    }
    #users-connected {
      margin-top: 10px;
      text-align: center;
    }
    .logo-container {
      text-align: center;
      margin-bottom: 20px;
    }
    #chat-history-container {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 600px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 2000;
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #chat-history-container h3 {
      margin-top: 0;
    }
    #chat-history-container.active {
      display: block;
    }
    #close-history {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Bienvenido, {{ user.apellido }} ({{ user.position }})</h1>
    <div class="menu-container">
      <img src="/templates/menu.png" alt="Menú" class="menu-icon" onclick="toggleMenu()">
      <div class="menu" id="menu">
        <div class="menu-item" onclick="window.location.href='https://movil.nortur.ar/ingreso.aspx'">Transporte</div>
        <div class="menu-item">
          Checklist
          <div class="submenu">
            <div class="submenu-item" onclick="window.location.href='https://login.microsoftonline.com/organizations/oauth2/v2.0/authorize?client_id=c9a559d2-7aab-4f13-a6ed-e7e9c52aec87&redirect_uri=https%3A%2F%2Fforms.office.com%2Flanding&state=eyJ2ZXJzaW9uIjoxLCJkYXRhIjp7IklkZW50aXR5UHJvdmlkZXIiOiJBWG85LS01cjJBRy1kTk4tMG5xYTNvcVA1MXR3ZTgyVElFRkhZUGstdWNxQktZSWF6UVgxS2dHVGpRRjdRdFhaMWs2S01pN01lMXN0ejVyZUN6SEhKeFEiLCIucmVkaXJlY3QiOiJodHRwczovL2Zvcm1zLm9mZmljZS5jb20vUGFnZXMvUmVzcG9uc2VQYWdlLmFzcHg_aWQ9QnI0M2dCQmRMVUdFX25WOE9YYzFKWnRsVzhhd0V0aE5nM0N0ZklLZ0NwdFVRVlpFUjBwUFMxazFOa1JDVWxOT01qUkZNRWxXV1ZSU1JDNHUmcXJjb2RlPXRydWUmc2lkPTg5ZWUzZDBiLTRkMTYtNDk4Ny04NTY5LWRlZmQ5N2VlNmMzMiIsIi54c3JmIjoiQWVxNzNZeVRzTTdvTmdaRUoyY3RmMmJZeTJKLWpwWlN6STkyZ1BBMUU0dE1Ob2dZUkRPTGY2eGQ0eWxfeU9PbE5KRlNTUkFNT0N0bHg2QnFhVmd3UDRKQjFDaEdEQmVzMWtmM2h0OHFvM0w5aUdDYk5TcXQwWUtQX1N6OW41X0FEZyIsIk9wZW5JZENvbm5lY3QuQ29kZS5SZWRpcmVjdFVyaSI6IkFVd1Nsel90WHZ0VGZLVWtwSUJ6OWhXTERyQ2NONHVmaVVVdU1TM2NGanh5SkZVM1MzeG9Pb3ZKX1pCeEEzdUdkOUd5MzE2LUdVN212c01KVFF1MWxZWUQtUjhla0VqVlNLOGpZSG1oQXB1SGVnX3FKVU1tbXQ0MTBtM3N2RVN6UmcifX0&response_type=code%20id_token&scope=openid%20profile&response_mode=form_post&nonce=638815691676705552.NGQ0ZjhmYTEtMGE3Zi00ODA4LTlmMGYtNjBkODEwMjBmZjZlYzA1YzIxMjYtODc3Yi00ZjdjLWFlMzItNWM0MTI4ZmYwMjRl&msafed=0&x-client-SKU=ID_NET9_0&x-client-ver=8.3.0.0'">Tractor liviano</div>
            <div class="submenu-item" onclick="window.location.href='https://forms.office.com/pages/responsepage.aspx?id=Br43gBBdLUGE_nV8OXc1JfRQIdLO2yJBh39S3G1D-n9UMUE3N1NPT1NOQlBFTUxBUUlHUklCVDNCQS4u&origin=QRCode&route=shorturl'">Radio</div>
            <div class="submenu-item" onclick="window.location.href='https://login.microsoftonline.com/organizations/oauth2/v2.0/authorize?client_id=c9a559d2-7aab-4f13-a6ed-e7e9c52aec87&redirect_uri=https%3A%2F%2Fforms.office.com%2Flanding&state=eyJ2ZXJzaW9uIjoxLCJkYXRhIjp7IklkZW50aXR5UHJvdmlkZXIiOiJBWDVHMFRYWm1Kc0FoX3dKSmZvV2JHZWpsN1JZV3czMHV1d3BpeHNWRE0ybTJVcHl5TkEwM2ZfR3U3SEIxU1daaXgxc3pJRkVjUEdlZ0dVSWVicEFiZWciLCIucmVkaXJlY3QiOiJodHRwczovL2Zvcm1zLm9mZmljZS5jb20vUGFnZXMvUmVzcG9uc2VQYWdlLmFzcHg_aWQ9QnI0M2dCQmRMVUdFX25WOE9YYzFKWnRsVzhhd0V0aE5nM0N0ZklLZ0NwdFVRVlpFUjBwUFMxazFOa1JDVWxOT01qUkZNRWxXV1ZSU1JDNHUmcXJjb2RlPXRydWUmc2lkPTkxMTMyMjU3LTBkMjItNGFmZS1iYzZmLWQ5OTMzZjJlYzZmMCIsIi54c3JmIjoiQVJyUmNoWXdPdTZGeVBDanQ4VTlFQXdxQXFaRUxmUkxvOXdxMmlJdmtMdlgwcmhZVnQxWXZsVnNzRmNpdTRuMTh3N25DVzR2ckZBRlNWVksxZWV3QmREeElPODltenhiUVN3YTcyRmdDYkFxZDZrSVBXS3BjT3V5Y203WjNlNW1zQSIsIk9wZW5JZENvbm5lY3QuQ29kZS5SZWRpcmVjdFVyaSI6IkFVUmlVcGZxSThmZy1wVXhmTTB0OTdMVlhEQ09LbUdTcmNCd2t3di1mdTlNS2VpZ1RMNVN3WDJhb2ktUXg0cFNLSzJCUjdPcDByUjZmOWlaSl95Q3hSVTItdzRGa3VrZ2xXOUxqekdPUU1sMjFmeWFJOUVXNXpXd3NzdVJWTUdtaEEifX0&response_type=code%20id_token&scope=openid%20profile&response_mode=form_post&nonce=638815692221692778.YmY0YTIxODktYzAzMi00MzNjLTgyYzctYmNjNDVlNzc1NWE4MGY3YjM1MDQtZDg0Yi00ZjhjLTk3NzMtYzUwZjQ4NzkwMDM4&msafed=0&x-client-SKU=ID_NET9_0&x-client-ver=8.3.0.0'">Escalera</div>
          </div>
        </div>
        <div class="menu-item" onclick="window.location.href='https://aeroweb.aerolineas.com.ar/es-ar/Account/Login?ReturnUrl=%2f'">Aeroweb</div>
        <div class="menu-item" onclick="showGuardia()">Guardia</div>
        <div class="menu-item" onclick="showChatHistory()">Historial</div>
        <div class="menu-item" onclick="window.location.href='http://www.tams.com.ar/organismos/vuelos.aspx'">Tams</div>
        <div class="menu-item" onclick="window.location.href='http://www.flightradar24.com/'">Flightradar24</div>
      </div>
    </div>
    <button class="logout-btn" onclick="window.location.href='/logout'">Cerrar Sesión</button>
  </div>

  <div class="container">
    <div class="logo-container">
      <img src="/templates/logo.png" alt="Logo" style="max-width: 200px;">
    </div>

    <div id="map-container">
      <h3 style="margin: 0; padding: 10px; background-color: #007bff; color: white; border-top-left-radius: 8px; border-top-right-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
        Mapa de Vuelos
        <button id="map-toggle">−</button>
      </h3>
      <div id="map"></div>
    </div>

    <div id="filters">
      <label>Vuelos disponibles</label>
      <input type="text" id="search-input" placeholder="Ej. AR AEP EZE">
      <button onclick="filterFlights()">Filtrar</button>
    </div>

    <div class="update-info">
      <span>Última actualización: <span id="last-update">Cargando...</span></span>
      <button id="update-btn" onclick="updateFlightsTable()">Actualizar vuelos</button>
      <span>Habilitar voz para llegadas: <input type="checkbox" id="voice-notifications"></span>
      <span>Usuarios conectados: <span id="users-count">0</span></span>
      <div id="users-connected"></div>
    </div>

    <div id="flights-table-container">
      <table id="flights-table">
        <thead>
          <tr>
            <th>Vuelo</th>
            <th>Aerolínea</th>
            <th>Salida</th>
            <th>Arribo</th>
            <th>Hora Salida</th>
            <th>Hora Arribo</th>
            <th>Estado</th>
            <th>➕</th>
          </tr>
        </thead>
        <tbody id="flights-tbody"></tbody>
      </table>
      <div id="pagination">
        <button id="prev-page" disabled>Anterior</button>
        <span id="page-info">Página 1 de 1</span>
        <button id="next-page" disabled>Siguiente</button>
      </div>
    </div>

    <div id="chat-container">
      <h3>
        <img src="/templates/msn.png" alt="Chat" id="chat-title-img">
        <span id="unread-count">0</span>
        <button id="chat-toggle">−</button>
      </h3>
      <div id="chat-messages"></div>
      <div id="chat-input">
        <input type="text" id="chat-message-input" placeholder="Escribe un mensaje...">
        <button id="send-message">Enviar</button>
        <button id="record-audio">Grabar Audio</button>
        <span id="recording-status"></span>
      </div>
    </div>

    <div id="chat-history-container">
      <h3>Historial del Chat (Últimos 7 días)</h3>
      <button id="close-history" onclick="closeChatHistory()">✕</button>
      <div id="chat-history-messages"></div>
    </div>
  </div>

  <script>
    // Inicializar el mapa
    const map = L.map("map").setView([-34.5592, -58.4156], 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let markers = [];

    // Función para actualizar el mapa
    function updateMap(flights) {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      flights.forEach(flight => {
        if (flight.lat && flight.lon) {
          const marker = L.marker([flight.lat, flight.lon]).addTo(map);
          marker.bindPopup(`
            <b>Vuelo:</b> ${flight.flight_iata}<br>
            <b>Aerolínea:</b> ${flight.airline_name}<br>
            <b>Salida:</b> ${flight.departure_airport} (${flight.departure})<br>
            <b>Arribo:</b> ${flight.arrival_airport} (${flight.arrival})<br>
            <b>Hora Est. Salida:</b> ${flight.estimated_departure}<br>
            <b>Hora Est. Arribo:</b> ${flight.estimated_arrival}<br>
            <b>Estado:</b> ${flight.status}
          `);
          markers.push(marker);
        }
      });
    }

    let currentPage = 1;
    let totalPages = 1;
    let allFlights = [];
    let filteredFlights = [];

    // Función para filtrar vuelos
    function filterFlights() {
      const searchInput = document.getElementById("search-input").value.toUpperCase().trim();
      const terms = searchInput.split(" ");

      filteredFlights = allFlights.filter(flight => {
        const airlineMatch = terms.includes("AR") ? flight.airline_iata === "AR" : true;
        const departureMatch = terms.some(term => flight.departure === term || flight.departure_airport.includes(term));
        const arrivalMatch = terms.some(term => flight.arrival === term || flight.arrival_airport.includes(term));
        return airlineMatch && (departureMatch || arrivalMatch);
      });

      totalPages = Math.ceil(filteredFlights.length / 25);
      currentPage = 1;
      renderFlights();
    }

    // Función para renderizar los vuelos
    function renderFlights() {
      const flightsPerPage = 25;
      const startIdx = (currentPage - 1) * flightsPerPage;
      const endIdx = startIdx + flightsPerPage;
      const paginatedFlights = filteredFlights.slice(startIdx, endIdx);

      const tbody = document.getElementById("flights-tbody");
      tbody.innerHTML = "";

      if (paginatedFlights.length > 0) {
        paginatedFlights.forEach((flight, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${flight.flight_iata}</td>
            <td>${flight.airline_name}</td>
            <td>${flight.departure_airport} (${flight.departure})</td>
            <td>${flight.arrival_airport} (${flight.arrival})</td>
            <td>${flight.estimated_departure}</td>
            <td>${flight.estimated_arrival}</td>
            <td>${flight.status}</td>
            <td><button onclick="toggleDetails(${startIdx + index})">➕</button></td>
          `;
          tbody.appendChild(row);

          const detailsRow = document.createElement("tr");
          detailsRow.classList.add("details-row");
          detailsRow.id = `details-${startIdx + index}`;
          detailsRow.innerHTML = `
            <td colspan="8">
              <strong>Detalles del vuelo:</strong><br>
              Nombre completo del aeropuerto de salida: ${flight.departure_airport}<br>
              Nombre completo del aeropuerto de llegada: ${flight.arrival_airport}<br>
              Hora programada de salida: ${flight.scheduled_departure}<br>
              Retraso de salida: ${flight.departure_delay} minutos<br>
              Terminal de salida: ${flight.departure_terminal}<br>
              Puerta de salida: ${flight.departure_gate}<br>
              Hora programada de llegada: ${flight.scheduled_arrival}<br>
              Retraso de llegada: ${flight.arrival_delay} minutos<br>
              Terminal de llegada: ${flight.arrival_terminal}<br>
              Puerta de llegada: ${flight.arrival_gate}<br>
              Tipo de avión: ${flight.aircraft}<br>
              Observaciones: ${flight.observations}
            </td>
          `;
          tbody.appendChild(detailsRow);
        });

        updateMap(paginatedFlights);
        document.getElementById("page-info").textContent = `Página ${currentPage} de ${totalPages}`;
        document.getElementById("prev-page").disabled = currentPage === 1;
        document.getElementById("next-page").disabled = currentPage === totalPages;
      } else {
        tbody.innerHTML = `<tr><td colspan="8">No se encontraron vuelos.</td></tr>`;
        updateMap([]);
        document.getElementById("page-info").textContent = `Página 1 de 1`;
        document.getElementById("prev-page").disabled = true;
        document.getElementById("next-page").disabled = true;
      }
    }

    // Función para toggle de detalles
    function toggleDetails(index) {
      const detailsRow = document.getElementById(`details-${index}`);
      detailsRow.classList.toggle("visible");
    }

    // Función para actualizar la tabla de vuelos
    async function updateFlightsTable() {
      try {
        const response = await fetch(`/flights?page=${currentPage}`);
        const data = await response.json();

        allFlights = data.flights || [];
        filteredFlights = [...allFlights];
        totalPages = data.total_pages || 1;
        renderFlights();

        if (data.failed_sources && data.failed_sources.length > 0) {
          alert(`No se pudieron obtener datos de las siguientes fuentes: ${data.failed_sources.join(", ")}`);
        }

        const now = new Date();
        document.getElementById("last-update").textContent = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

        const voiceEnabled = document.getElementById("voice-notifications").checked;
        if (voiceEnabled) {
          data.flights.forEach(flight => {
            if (flight.status === "landed" && flight.arrival === "AEP") {
              const msg = new SpeechSynthesisUtterance(`El vuelo ${flight.flight_iata} de ${flight.airline_name} con origen ${flight.departure_airport} ha llegado a Aeroparque.`);
              msg.lang = "es-ES";
              window.speechSynthesis.speak(msg);
            }
          });
        }
      } catch (error) {
        console.error("Error al obtener los vuelos:", error);
        const tbody = document.getElementById("flights-tbody");
        tbody.innerHTML = `<tr><td colspan="8">Error al cargar los vuelos.</td></tr>`;
        updateMap([]);
      }
    }

    document.getElementById("prev-page").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderFlights();
      }
    });

    document.getElementById("next-page").addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderFlights();
      }
    });

    updateFlightsTable();

    const ws = new WebSocket(`wss://${window.location.host}/ws`);
    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.type === "user_count") {
          document.getElementById("users-count").textContent = data.count;
          fetch("/users")
            .then(res => res.json())
            .then(userData => {
              const usersDiv = document.getElementById("users-connected");
              usersDiv.innerHTML = "";
              userData.users.forEach(user => {
                const userItem = document.createElement("div");
                userItem.textContent = `${user.apellido} (${user.legajo})`;
                usersDiv.appendChild(userItem);
              });
            })
            .catch(error => {
              console.error("Error al obtener la lista de usuarios:", error);
            });
        }
      } catch (error) {
        console.error("Error al parsear mensaje de WebSocket:", error);
      }
    };

    // WebSocket para el chat global
    const chatSocket = new WebSocket(`wss://${window.location.host}/chat`);
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let stream = null;
    let unreadMessages = 0;
    let isChatMinimized = false;
    let isMapMinimized = false;

    chatSocket.onopen = () => {
      console.log("Conexión de chat establecida");
    };

    chatSocket.onmessage = (event) => {
      const message = JSON.parse(event.data);
      const chatMessages = document.getElementById("chat-messages");

      const messageElement = document.createElement("div");
      messageElement.classList.add("chat-message");

      if (message.type === "text") {
        messageElement.innerHTML = `<strong>${message.sender}</strong> (${message.timestamp}): ${message.content}`;
      } else if (message.type === "audio") {
        messageElement.innerHTML = `<strong>${message.sender}</strong> (${message.timestamp}): <audio controls src="${message.content}"></audio>`;
      }

      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      if (isChatMinimized) {
        unreadMessages++;
        const unreadCount = document.getElementById("unread-count");
        unreadCount.textContent = unreadMessages;
        unreadCount.style.display = "block";
      }
    };

    chatSocket.onclose = () => {
      console.log("Conexión de chat cerrada");
    };

    document.getElementById("send-message").addEventListener("click", () => {
      const input = document.getElementById("chat-message-input");
      const message = input.value.trim();
      if (message) {
        chatSocket.send(JSON.stringify({
          type: "text",
          sender: "{{ user.apellido }} ({{ user.position }})",
          content: message
        }));
        input.value = "";
      }
    });

    document.getElementById("record-audio").addEventListener("click", async () => {
      const recordButton = document.getElementById("record-audio");
      const status = document.getElementById("recording-status");

      if (!isRecording) {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = () => {
              const base64Audio = reader.result;
              chatSocket.send(JSON.stringify({
                type: "audio",
                sender: "{{ user.apellido }} ({{ user.position }})",
                content: base64Audio
              }));
            };
            // Detener el stream de audio para apagar el micrófono
            if (stream) {
              stream.getTracks().forEach(track => track.stop());
              stream = null;
            }
          };

          mediaRecorder.start();
          isRecording = true;
          recordButton.textContent = "Parar Grabación";
          status.textContent = "Grabando...";
        } catch (error) {
          console.error("Error al acceder al micrófono:", error);
          status.textContent = "Error al grabar audio.";
        }
      } else {
        mediaRecorder.stop();
        isRecording = false;
        recordButton.textContent = "Grabar Audio";
        status.textContent = "";
      }
    });

    document.getElementById("chat-message-input").addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        document.getElementById("send-message").click();
      }
    });

    document.getElementById("chat-toggle").addEventListener("click", () => {
      const chatContainer = document.getElementById("chat-container");
      const toggleButton = document.getElementById("chat-toggle");
      isChatMinimized = !isChatMinimized;
      chatContainer.classList.toggle("minimized", isChatMinimized);
      toggleButton.textContent = isChatMinimized ? "+" : "−";
      if (!isChatMinimized) {
        unreadMessages = 0;
        document.getElementById("unread-count").style.display = "none";
      }
    });

    document.getElementById("map-toggle").addEventListener("click", () => {
      const mapContainer = document.getElementById("map-container");
      const toggleButton = document.getElementById("map-toggle");
      isMapMinimized = !isMapMinimized;
      mapContainer.classList.toggle("minimized", isMapMinimized);
      toggleButton.textContent = isMapMinimized ? "+" : "−";
      if (!isMapMinimized) {
        map.invalidateSize();
      }
    });

    // Funciones para el menú desplegable
    function toggleMenu() {
      const menu = document.getElementById("menu");
      menu.classList.toggle("active");
    }

    // Función para mostrar la lista de usuarios (Guardia)
    function showGuardia() {
      fetch("/users")
        .then(res => res.json())
        .then(data => {
          const userList = data.users.map(user => `${user.apellido} (${user.legajo})`).join("<br>");
          const newWindow = window.open("", "_blank");
          newWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <title>Guardia</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h2 { color: #007bff; }
              </style>
            </head>
            <body>
              <h2>Lista de Usuarios (Guardia)</h2>
              ${userList || "No hay usuarios disponibles."}
            </body>
            </html>
          `);
          newWindow.document.close();
        })
        .catch(error => {
          console.error("Error al obtener la lista de usuarios:", error);
          alert("Error al cargar la lista de usuarios.");
        });
    }

    // Función para mostrar el historial del chat
    function showChatHistory() {
      fetch("/chat-history")
        .then(res => res.json())
        .then(data => {
          const chatHistoryMessages = document.getElementById("chat-history-messages");
          chatHistoryMessages.innerHTML = "";
          if (data.messages && data.messages.length > 0) {
            data.messages.forEach(message => {
              const messageElement = document.createElement("div");
              messageElement.classList.add("chat-message");
              if (message.type === "text") {
                messageElement.innerHTML = `<strong>${message.sender}</strong> (${message.timestamp}): ${message.content}`;
              } else if (message.type === "audio") {
                messageElement.innerHTML = `<strong>${message.sender}</strong> (${message.timestamp}): <audio controls src="${message.content}"></audio>`;
              }
              chatHistoryMessages.appendChild(messageElement);
            });
          } else {
            chatHistoryMessages.innerHTML = "No hay mensajes en el historial.";
          }
          document.getElementById("chat-history-container").classList.add("active");
        })
        .catch(error => {
          console.error("Error al obtener el historial del chat:", error);
          alert("Error al cargar el historial del chat.");
        });
    }

    function closeChatHistory() {
      document.getElementById("chat-history-container").classList.remove("active");
    }
  </script>
</body>
</html>
